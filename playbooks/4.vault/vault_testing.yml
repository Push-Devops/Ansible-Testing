#ansible-playbook -i invfile Playbooks/vault_testing.yml -vv --ask-vault-pass
---
- name: Run AWS Cli Commands On All Servers
  hosts: pvt
  gather_facts: yes
  become: yes
  become_user: root
  serial: 3
  vars:
    user_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      66343238646264636139643561616132306363323138643735633762323661373233666430663164
      3237323232653865646130343937306532633864663961350a383364386237396135333335373863
      33393261613665303730613461393362383261333830333834353931323630653335326161633536
      6363323464316265360a653961663935613639663264366664323236373438313861383932626336
      6666
    elastic_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      30643332646362626336383264303533386336393835326362323438626531383234353830323666
      3866663432306562616435326237633266633034393763640a326466616433396533616265326439
      61353438393539353265363262343539323237313532366537353863663838626564383539343262
      3834646562666435360a616265326266336630336634646334616261356263303764383433343864
      66396661336336336366623063636366343665656538333561306336643537326366353534316162
      34346338363133636535336136633164656239386130313734323939343263623035316633343134
      613165636663356163373236343339623732
  tasks:
    - name: Create .aws folder
      shell: mkdir -p /root/.aws
      ignore_errors: yes
    - name: Copy Encrypted File To /tmp
      copy:
        src: /tmp/{{item}} #This Encrypted File Must Be Created Prior To Running The Playbook.
        dest: /tmp/{{item}}
        owner: root
        group: root
        mode: "0600"
      with_items:
        - aws_creds
        - tls.key
        - tls.crt
    - name: Copy Encrypted Credentials File To .aws folder
      copy:
        src: /tmp/aws_creds #This Encrypted File Must Be Created Prior To Running The Playbook.
        dest: /root/.aws/credentials
        owner: root
        group: root
        mode: "0600"
    - name: Check S3 Buckets
      shell: aws s3 ls | cut -d " " -f 3
      register: buckets
    - name: Print Bucket Name
      debug:
        var: buckets
    - name: Get VPCS
      shell: aws ec2 describe-vpcs | jq ".Vpcs[].VpcId" -r
      register: vpcs
    - name: Print VPC ID
      debug:
        var: vpcs
    - name: Creating admin "{{item}}"
      user:
        name: "{{item}}"
        state: present
        comment: Admin User "{{item}}"
        groups: root
        shell: /bin/bash
        group: sudo
        password: "{{ '%s' | format(user_password) | regex_replace('\n', '') | password_hash('sha512') }}"
        password_expire_min: 1
      with_items:
        - Avinash
        - Saikiran
        - Gnane
    - name: Replace Password Authentication To Yes
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^PasswordAuthentication no"
        line: PasswordAuthentication yes
        backup: yes
      notify:
        - Restart SSH Service
    - name: Install Elastic Agent
      shell: |
        curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.10.4-linux-x86_64.tar.gz
        tar xzvf elastic-agent-8.10.4-linux-x86_64.tar.gz
        cd elastic-agent-8.10.4-linux-x86_64
        sudo ./elastic-agent install --url=https://ee71b9fe333346e0ac91f0529680a324.fleet.us-east-1.aws.found.io:443 --enrollment-token={{ elastic_password }}
    - name: Copy Encrypted /tmp/heartbeat.yml File To /etc/heartbeat/ folder
      copy:
        src: /tmp/heartbeat.yml #This Encrypted File Must Be Created Prior To Running The Playbook.
        dest: /etc/heartbeat/heartbeat.yml
        owner: root
        group: root
        mode: "0600"
      notify:
        - Restart elastic-agent
  handlers:
    - name: Restart SSH Service
      shell: service sshd restart
    - name: Restart elastic-agent
      shell: sudo heartbeat setup && sudo service heartbeat-elastic start
